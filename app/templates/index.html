<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Scorer</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        function updateMoodValue() {
            const moodSlider = document.getElementById('mood');
            const moodValue = document.getElementById('mood-value');
            moodValue.textContent = moodSlider.value;
            updateFinalScore();
        }

        function updateFinalScore() {
            const taste = parseInt(document.getElementById('taste').value) || 0;
            const experience = parseInt(document.getElementById('experience').value) || 0;
            const value = parseInt(document.getElementById('value').value) || 0;
            const mood = parseFloat(document.getElementById('mood').value) || 1.0;
            
            const finalScore = (taste + experience + value) / mood;
            document.getElementById('final-score').textContent = finalScore.toFixed(2);
        }

        function clearForm() {
            document.getElementById('restaurant-form').reset();
            document.getElementById('date_visited').value = new Date().toISOString().split('T')[0];
            document.getElementById('mood').value = '1.0';
            document.getElementById('image-preview-1').src = '#';
            document.getElementById('image-preview-1').classList.add('hidden');
            document.getElementById('image-path-1').value = '';
            document.getElementById('image-preview-2').src = '#';
            document.getElementById('image-preview-2').classList.add('hidden');
            document.getElementById('image-path-2').value = '';
            updateMoodValue();
            updateFinalScore();
        }

        function toggleHistory() {
            const historySection = document.getElementById('history-section');
            const formSection = document.getElementById('form-section');
            const historyButton = document.getElementById('history-button');
            
            console.log('toggleHistory called');
            
            if (historySection.classList.contains('hidden')) {
                // Show history, hide form
                historySection.classList.remove('hidden');
                formSection.classList.add('hidden');
                historyButton.textContent = 'Back to Form';
                historyButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                historyButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
                
                console.log('Showing history section');
                
                // Load history content if not already loaded
                const historyContent = document.getElementById('history-content');
                if (historyContent.innerHTML.trim() === '') {
                    console.log('Loading history content via HTMX');
                    try {
                        htmx.ajax('GET', '/history', {target: '#history-content'});
                    } catch (error) {
                        console.error('HTMX ajax call failed:', error);
                    }
                }
            } else {
                // Show form, hide history
                historySection.classList.add('hidden');
                formSection.classList.remove('hidden');
                historyButton.textContent = 'See History';
                historyButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                historyButton.classList.add('bg-green-600', 'hover:bg-green-700');
                console.log('Showing form section');
            }
        }

        async function previewImage(event, previewId, hiddenInputId) {
            const file = event.target.files[0];
            const preview = document.getElementById(previewId);
            const hiddenInput = document.getElementById(hiddenInputId);

            if (!file) {
                preview.src = '#';
                preview.classList.add('hidden');
                hiddenInput.value = '';
                return;
            }

            const formData = new FormData();
            formData.append('image', file);
            
            // Show a loading indicator
            preview.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' preserveAspectRatio='xMidYMid' width='200' height='200' style='shape-rendering: auto; display: block; background: rgb(255, 255, 255);' xml:space='preserve'%3E%3Cpath d='M10 50A40 40 0 0 0 90 50A40 42 0 0 1 10 50' fill='%231d3f72' stroke='none'%3E%3CanimateTransform attributeName='transform' type='rotate' dur='1s' repeatCount='indefinite' keyTimes='0;1' values='0 50 51;360 50 51'/%3E%3C/path%3E%3C/svg%3E";
            preview.classList.remove('hidden');

            try {
                const response = await fetch('/upload-image-preview', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Image upload failed.');
                }

                const result = await response.json();
                preview.src = result.image_path;
                hiddenInput.value = result.image_path;

            } catch (error) {
                console.error('Error during preview upload:', error);
                alert('Could not generate a preview for this file. Please try another file.');
                preview.classList.add('hidden');
                hiddenInput.value = '';
            }
        }

        // Set today's date as default when page loads
        window.onload = function() {
            document.getElementById('date_visited').value = new Date().toISOString().split('T')[0];
            updateMoodValue();
            updateFinalScore();
        };
    </script>
</head>
<body class="bg-gray-50 min-h-screen py-4 sm:py-8">
    <div class="max-w-2xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-6 sm:p-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 sm:mb-8 text-center">Restaurant Scorer</h1>
            
            <!-- History Toggle Button -->
            <div class="text-center mb-6">
                <button id="history-button" onclick="toggleHistory()" 
                        class="bg-green-600 text-white py-2 px-6 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 font-medium transition duration-200">
                    See History
                </button>
            </div>
            
            <!-- Form Section -->
            <div id="form-section">
                <form id="restaurant-form" hx-post="/submit" hx-trigger="submit" hx-target="#response" hx-encoding="multipart/form-data" class="space-y-6">
                <!-- Restaurant Name -->
                <div>
                    <label for="restaurant_name" class="block text-sm font-medium text-gray-700 mb-2">Restaurant Name</label>
                    <input type="text" id="restaurant_name" name="restaurant_name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Google Maps Link -->
                <div>
                    <label for="gmaps_link" class="block text-sm font-medium text-gray-700 mb-2">Google Maps Link</label>
                    <input type="url" id="gmaps_link" name="gmaps_link" required
                           placeholder="https://maps.google.com/..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Date Visited -->
                <div>
                    <label for="date_visited" class="block text-sm font-medium text-gray-700 mb-2">Date Visited</label>
                    <input type="date" id="date_visited" name="date_visited" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Mood Slider -->
                <div>
                    <label for="mood" class="block text-sm font-medium text-gray-700 mb-2">
                        Baseline mood: <span id="mood-value" class="font-semibold text-blue-600">1.0</span>
                    </label>
                    <input type="range" id="mood" name="mood" min="0.5" max="1.5" step="0.1" value="1.0"
                           oninput="updateMoodValue()"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>Lower for bad mood</span>
                        <span>Higher for great mood</span>
                    </div>
                </div>

                <!-- Rating Fields -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Taste -->
                    <div>
                        <label for="taste" class="block text-sm font-medium text-gray-700 mb-2">Taste (0-10)</label>
                        <input type="number" id="taste" name="taste" min="0" max="10" required
                               oninput="updateFinalScore()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Experience -->
                    <div>
                        <label for="experience" class="block text-sm font-medium text-gray-700 mb-2">Experience (0-10)</label>
                        <input type="number" id="experience" name="experience" min="0" max="10" required
                               oninput="updateFinalScore()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Value -->
                    <div>
                        <label for="value" class="block text-sm font-medium text-gray-700 mb-2">Value (0-10)</label>
                        <input type="number" id="value" name="value" min="0" max="10" required
                               oninput="updateFinalScore()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Final Score Display -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-lg font-semibold text-blue-800">
                        Final Score: <span id="final-score" class="text-2xl">0.00</span>
                    </p>
                    <p class="text-sm text-blue-600 mt-1">
                        Calculated as: (Taste + Experience + Value) ÷ Mood
                    </p>
                </div>

                <!-- Image Uploads -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="image_1" class="block text-sm font-medium text-gray-700 mb-2">Photo 1</label>
                        <input type="file" id="image_1" name="image_1_upload" accept="image/*,.heic" onchange="previewImage(event, 'image-preview-1', 'image-path-1')"
                               class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <input type="hidden" id="image-path-1" name="image_path_1">
                        <img id="image-preview-1" class="mt-2 rounded-lg hidden w-full" src="#" alt="Image preview 1" />
                    </div>
                    <div>
                        <label for="image_2" class="block text-sm font-medium text-gray-700 mb-2">Photo 2</label>
                        <input type="file" id="image_2" name="image_2_upload" accept="image/*,.heic" onchange="previewImage(event, 'image-preview-2', 'image-path-2')"
                               class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <input type="hidden" id="image-path-2" name="image_path_2">
                        <img id="image-preview-2" class="mt-2 rounded-lg hidden w-full" src="#" alt="Image preview 2" />
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea id="notes" name="notes" rows="3"
                              placeholder="Any additional thoughts about the restaurant..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>

                <!-- Submit Button -->
                <button type="submit"
                        class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 font-medium text-base sm:text-lg transition duration-200">
                    Save Restaurant Score
                </button>
            </form>

            <!-- Response Area -->
            <div id="response" class="mt-6"></div>
        </div>

        <!-- History Section -->
            <div id="history-section" class="hidden bg-white rounded-lg shadow-lg p-6 sm:p-8">
                <div class="text-center mb-4">
                    <button hx-get="/history" hx-target="#history-content" 
                            class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 font-medium transition duration-200">
                        Load History
                    </button>
                </div>
                <div id="history-content" class="space-y-4">
                    <!-- History items will be loaded here by HTMX -->
                </div>
            </div>
        </div>
    </div>
</body>
</html> 